<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.refit.app.domain.chat.mapper.ChatMapper">
  <insert id="insertFromRequest" parameterType="map">
    <selectKey keyProperty="chatId" resultType="long" order="BEFORE">
      SELECT SEQ_CHAT.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO CHAT (
    CHAT_ID,
    CATEGORY_ID,
    MEMBER_ID,
    PRODUCT_ID,
    MESSAGE_CONTENT,
    CREATED_AT
    ) VALUES (
    #{chatId,         jdbcType=NUMERIC},
    #{req.categoryId, jdbcType=NUMERIC},
    #{memberId,       jdbcType=NUMERIC},
    #{req.productId,  jdbcType=NUMERIC},
    #{req.message,    jdbcType=VARCHAR},
    SYSTIMESTAMP
    )
  </insert>

  <select id="findByIdWithNickname"
    resultType="com.refit.app.domain.chat.dto.response.ChatMessageResponse">
    SELECT
      cm.CATEGORY_ID       AS categoryId,
      cm.MEMBER_ID         AS memberId,
      m.NICKNAME           AS nickname,
      cm.PRODUCT_ID        AS productId,
      cm.MESSAGE_CONTENT   AS message,
      m.PROFILE_URL        AS profileUrl,
      cm.CREATED_AT        AS createdAt
    FROM CHAT cm
           LEFT JOIN MEMBER m ON m.MEMBER_ID = cm.MEMBER_ID
    WHERE cm.CHAT_ID = #{chatId}
  </select>

  <!-- 카테고리 과거 히스토리: 최신 → 과거 (DESC) 정렬, beforeId 커서로 더 과거 페이지 -->
  <select id="findHistory" parameterType="map"
    resultType="com.refit.app.domain.chat.dto.ChatMessageDto">
    SELECT *
    FROM (
    SELECT
    c.CHAT_ID          AS chatId,
    c.CATEGORY_ID      AS categoryId,
    c.MEMBER_ID        AS memberId,
    m.NICKNAME         AS nickname,
    c.PRODUCT_ID       AS productId,
    c.MESSAGE_CONTENT  AS message,
    m.PROFILE_URL      AS profileUrl,
    c.CREATED_AT       AS createdAt
    FROM CHAT c
    LEFT JOIN MEMBER m
    ON m.MEMBER_ID = c.MEMBER_ID
    WHERE c.CATEGORY_ID = #{categoryId, jdbcType=NUMERIC}
    <if test="beforeId != null">
      AND c.CHAT_ID <![CDATA[ < ]]> #{beforeId, jdbcType=NUMERIC}
    </if>
    ORDER BY c.CHAT_ID DESC
    )
    WHERE ROWNUM &lt;= #{size, jdbcType=NUMERIC}
  </select>

  <select id="existsOlder" resultType="int">
    SELECT CASE WHEN EXISTS (
      SELECT 1
      FROM CHAT c
      WHERE c.CATEGORY_ID = #{categoryId, jdbcType=NUMERIC}
        AND c.CHAT_ID <![CDATA[ < ]]> #{beforeId, jdbcType=NUMERIC}
        AND ROWNUM &lt;= 1
    ) THEN 1 ELSE 0 END
    FROM DUAL
  </select>
</mapper>