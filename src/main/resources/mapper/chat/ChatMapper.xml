<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.refit.app.domain.chat.mapper.ChatMapper">
  <insert id="insertFromRequest" parameterType="map">
    <selectKey keyProperty="chatId" resultType="long" order="BEFORE">
      SELECT SEQ_CHAT.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO CHAT (
    CHAT_ID,
    CATEGORY_ID,
    MEMBER_ID,
    PRODUCT_ID,
    MESSAGE_CONTENT,
    CREATED_AT
    ) VALUES (
    #{chatId,         jdbcType=NUMERIC},
    #{req.categoryId, jdbcType=NUMERIC},
    #{memberId,       jdbcType=NUMERIC},
    #{req.productId,  jdbcType=NUMERIC},
    #{req.message,    jdbcType=VARCHAR},
    SYSTIMESTAMP
    )
  </insert>

  <select id="findByIdWithNickname"
    resultType="com.refit.app.domain.chat.dto.response.ChatMessageResponse">
    SELECT
      cm.CATEGORY_ID       AS categoryId,
      cm.MEMBER_ID         AS memberId,
      m.NICKNAME           AS nickname,
      cm.PRODUCT_ID        AS productId,
      cm.MESSAGE_CONTENT   AS message,
      m.PROFILE_URL        AS profileUrl,
      cm.CREATED_AT        AS createdAt
    FROM CHAT cm
           LEFT JOIN MEMBER m ON m.MEMBER_ID = cm.MEMBER_ID
    WHERE cm.CHAT_ID = #{chatId}
  </select>
</mapper>