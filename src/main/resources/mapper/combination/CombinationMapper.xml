<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.refit.app.domain.combination.mapper.CombinationMapper">

    <!-- 조합 기본 정보 조회 -->
    <select id="findCombinationById" parameterType="long" resultType="com.refit.app.domain.combination.dto.response.CombinationResponse">
        SELECT
            c.COMBINATION_ID   AS combinationId,
            c.COMBINATION_NAME AS combinationName,
            c.COMBINATION_DESCRIPTION AS combinationDescription
        FROM COMBINATION c
        WHERE c.COMBINATION_ID = #{combinationId}
    </select>

    <!-- 여러 조합 조회 -->
    <select id="findCombinationsByIds" resultType="com.refit.app.domain.me.dto.MyCombinationDto">
        SELECT
        c.COMBINATION_ID   AS combinationId,
        c.MEMBER_ID        AS memberId,
        m.NICKNAME         AS nickname,
        m.PROFILE_URL      AS profileUrl,
        c.COMBINATION_NAME AS combinationName,
        c.LIKES            AS likes
        FROM COMBINATION c
        JOIN MEMBER m ON c.MEMBER_ID = m.MEMBER_ID
        WHERE c.COMBINATION_ID IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND c.DELETED_AT IS NULL
        ORDER BY c.COMBINATION_ID DESC
    </select>


    <!-- 조합에 속한 상품 목록 조회 -->
    <select id="findProductsByCombinationId" parameterType="long" resultType="com.refit.app.domain.combination.dto.CombinationProductDto">
        SELECT
            p.PRODUCT_ID    AS productId,
            p.PRODUCT_NAME  AS productName,
            p.BRAND_NAME    AS brandName,
            p.PRICE         AS price,
            p.DISCOUNT_RATE AS discountRate,
            p.THUMBNAIL_URL AS thumbnailUrl
        FROM COMBINATION_ITEM ci
                 JOIN PRODUCT p ON ci.PRODUCT_ID = p.PRODUCT_ID
        WHERE ci.COMBINATION_ID = #{combinationId}
        ORDER BY ci.COMBINATION_ITEM_ID
    </select>

    <!-- 조합 좋아요 증가 -->
    <update id="increaseLike">
        UPDATE COMBINATION
        SET LIKES = LIKES + 1,
            UPDATED_AT = SYSTIMESTAMP
        WHERE COMBINATION_ID = #{combinationId}
    </update>

    <!-- 조합 좋아요 감소 -->
    <update id="decreaseLike">
        UPDATE COMBINATION
        SET LIKES = CASE WHEN LIKES > 0 THEN LIKES - 1 ELSE 0 END,
            UPDATED_AT = SYSTIMESTAMP
        WHERE COMBINATION_ID = #{combinationId}
    </update>

</mapper>
