<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.refit.app.domain.combination.mapper.CombinationMapper">

    <!-- 조합 기본 정보 조회 -->
    <select id="findCombinationById" parameterType="long" resultType="com.refit.app.domain.combination.dto.response.MyCombinationResponse">
        SELECT
            c.COMBINATION_ID   AS combinationId,
            c.COMBINATION_NAME AS combinationName,
            c.COMBINATION_DESCRIPTION AS combinationDescription
        FROM COMBINATION c
        WHERE c.COMBINATION_ID = #{combinationId}
    </select>

    <!-- 여러 조합 조회 -->
    <select id="findCombinationsByIds" resultType="com.refit.app.domain.me.dto.MyCombinationDto">
        SELECT
        c.COMBINATION_ID   AS combinationId,
        c.MEMBER_ID        AS memberId,
        m.NICKNAME         AS nickname,
        m.PROFILE_URL      AS profileUrl,
        c.COMBINATION_NAME AS combinationName,
        c.LIKES            AS likes
        FROM COMBINATION c
        JOIN MEMBER m ON c.MEMBER_ID = m.MEMBER_ID
        WHERE c.COMBINATION_ID IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND c.DELETED_AT IS NULL
        ORDER BY c.COMBINATION_ID DESC
    </select>


    <!-- 조합에 속한 상품 목록 조회 -->
    <select id="findProductsByCombinationId" parameterType="long" resultType="com.refit.app.domain.combination.dto.CombinationProductDto">
        SELECT
            p.PRODUCT_ID    AS productId,
            p.PRODUCT_NAME  AS productName,
            p.BRAND_NAME    AS brandName,
            p.PRICE         AS price,
            p.DISCOUNT_RATE AS discountRate,
            p.THUMBNAIL_URL AS thumbnailUrl
        FROM COMBINATION_ITEM ci
                 JOIN PRODUCT p ON ci.PRODUCT_ID = p.PRODUCT_ID
        WHERE ci.COMBINATION_ID = #{combinationId}
        ORDER BY ci.COMBINATION_ITEM_ID
    </select>

    <!-- 조합 좋아요 증가 -->
    <update id="increaseLike">
        UPDATE COMBINATION
        SET LIKES = LIKES + 1,
            UPDATED_AT = SYSTIMESTAMP
        WHERE COMBINATION_ID = #{combinationId}
    </update>

    <!-- 조합 좋아요 감소 -->
    <update id="decreaseLike">
        UPDATE COMBINATION
        SET LIKES = CASE WHEN LIKES > 0 THEN LIKES - 1 ELSE 0 END,
            UPDATED_AT = SYSTIMESTAMP
        WHERE COMBINATION_ID = #{combinationId}
    </update>

    <!-- 조합 조회 -->
    <select id="findCombinations"
            parameterType="map"
            resultType="com.refit.app.domain.combination.dto.CombinationResponseDto">
        WITH COMB_PRICE AS (
        SELECT
        c.COMBINATION_ID,
        c.COMBINATION_NAME,
        c.LIKES,
        c.CREATED_AT,
        c.BH_TYPE,
        c.MEMBER_ID,
        m.NICKNAME,
        m.PROFILE_URL,
        SUM(p.PRICE) AS originalTotalPrice,
        SUM(TRUNC(p.PRICE * (100 - NVL(p.DISCOUNT_RATE, 0)) / 100, -2)) AS discountedTotalPrice
        FROM COMBINATION c
        JOIN MEMBER m ON c.MEMBER_ID = m.MEMBER_ID
        JOIN COMBINATION_ITEM ci ON ci.COMBINATION_ID = c.COMBINATION_ID
        JOIN PRODUCT p ON ci.PRODUCT_ID = p.PRODUCT_ID
        <where>
            <if test="searchMode eq 'combination' and keyword != null and keyword != ''">
                AND c.COMBINATION_NAME LIKE '%' || #{keyword} || '%'
            </if>
            <if test="searchMode eq 'product' and keyword != null and keyword != ''">
                AND p.PRODUCT_ID IN (
                SELECT p2.PRODUCT_ID
                FROM PRODUCT p2
                WHERE p2.PRODUCT_NAME LIKE '%' || #{keyword} || '%'
                )
            </if>
        </where>
        GROUP BY c.COMBINATION_ID, c.COMBINATION_NAME, c.LIKES, c.CREATED_AT, c.BH_TYPE, c.MEMBER_ID, m.NICKNAME, m.PROFILE_URL
        )
        SELECT * FROM COMB_PRICE cp
        <where>
            <if test="bhType != null">
                AND cp.BH_TYPE = #{bhType}
            </if>

            <!-- 커서 기반 페이지네이션 -->
            <if test="combinationId != null">
                <choose>
                    <when test="sort eq 'popular'">
                        AND (
                        (cp.LIKES &lt; (SELECT c2.LIKES FROM COMB_PRICE c2 WHERE c2.COMBINATION_ID = #{combinationId}))
                        OR (cp.LIKES = (SELECT c2.LIKES FROM COMB_PRICE c2 WHERE c2.COMBINATION_ID = #{combinationId})
                        AND cp.COMBINATION_ID &gt; #{combinationId})
                        )
                    </when>
                    <when test="sort eq 'latest'">
                        AND (
                        (cp.CREATED_AT &lt; (SELECT c2.CREATED_AT FROM COMB_PRICE c2 WHERE c2.COMBINATION_ID = #{combinationId}))
                        OR (cp.CREATED_AT = (SELECT c2.CREATED_AT FROM COMB_PRICE c2 WHERE c2.COMBINATION_ID = #{combinationId})
                        AND cp.COMBINATION_ID &gt; #{combinationId})
                        )
                    </when>
                    <when test="sort eq 'lowPrice'">
                        AND (
                        (cp.discountedTotalPrice &gt; (SELECT c2.discountedTotalPrice FROM COMB_PRICE c2 WHERE c2.COMBINATION_ID = #{combinationId}))
                        OR (cp.discountedTotalPrice = (SELECT c2.discountedTotalPrice FROM COMB_PRICE c2 WHERE c2.COMBINATION_ID = #{combinationId})
                        AND cp.COMBINATION_ID &gt; #{combinationId})
                        )
                    </when>
                    <when test="sort eq 'highPrice'">
                        AND (
                        (cp.discountedTotalPrice &lt; (SELECT c2.discountedTotalPrice FROM COMB_PRICE c2 WHERE c2.COMBINATION_ID = #{combinationId}))
                        OR (cp.discountedTotalPrice = (SELECT c2.discountedTotalPrice FROM COMB_PRICE c2 WHERE c2.COMBINATION_ID = #{combinationId})
                        AND cp.COMBINATION_ID &gt; #{combinationId})
                        )
                    </when>
                </choose>
            </if>
        </where>
        <choose>
            <when test="sort eq 'popular'">
                ORDER BY cp.LIKES DESC, cp.COMBINATION_ID ASC
            </when>
            <when test="sort eq 'latest'">
                ORDER BY cp.CREATED_AT DESC, cp.COMBINATION_ID ASC
            </when>
            <when test="sort eq 'lowPrice'">
                ORDER BY cp.discountedTotalPrice ASC, cp.COMBINATION_ID ASC
            </when>
            <when test="sort eq 'highPrice'">
                ORDER BY cp.discountedTotalPrice DESC, cp.COMBINATION_ID ASC
            </when>
            <otherwise>
                ORDER BY cp.CREATED_AT DESC, cp.COMBINATION_ID ASC
            </otherwise>
        </choose>
        FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- 조합 내 productImages 조회 -->
    <select id="findProductImagesByCombinationId" parameterType="long" resultType="string">
        SELECT p.THUMBNAIL_URL
        FROM COMBINATION_ITEM ci
                 JOIN PRODUCT p ON ci.PRODUCT_ID = p.PRODUCT_ID
        WHERE ci.COMBINATION_ID = #{combinationId}
    </select>

    <!-- 조합 개수 -->
    <select id="countCombinations" parameterType="map" resultType="long">
        SELECT COUNT(DISTINCT c.COMBINATION_ID)
        FROM COMBINATION c
        JOIN MEMBER m ON c.MEMBER_ID = m.MEMBER_ID
        JOIN COMBINATION_ITEM ci ON ci.COMBINATION_ID = c.COMBINATION_ID
        JOIN PRODUCT p ON ci.PRODUCT_ID = p.PRODUCT_ID
        <where>
            <if test="bhType != null">
                AND c.BH_TYPE = #{bhType}
            </if>
            <if test="searchMode eq 'combination' and keyword != null and keyword != ''">
                AND c.COMBINATION_NAME LIKE '%' || #{keyword} || '%'
            </if>
            <if test="searchMode eq 'product' and keyword != null and keyword != ''">
                AND p.PRODUCT_ID IN (
                SELECT p2.PRODUCT_ID
                FROM PRODUCT p2
                WHERE p2.PRODUCT_NAME LIKE '%' || #{keyword} || '%'
                )
            </if>
        </where>
    </select>

    <select id="findCombinationDetail" parameterType="long" resultType="com.refit.app.domain.combination.dto.response.CombinationDetailResponse">
        SELECT
            c.COMBINATION_ID   AS combinationId,
            c.COMBINATION_NAME AS combinationName,
            c.COMBINATION_DESCRIPTION AS combinationDescription,
            m.MEMBER_ID        AS memberId,
            m.NICKNAME         AS nickname,
            m.PROFILE_URL      AS profileUrl,
            (
                SELECT SUM(p.PRICE)
                FROM COMBINATION_ITEM ci
                         JOIN PRODUCT p ON ci.PRODUCT_ID = p.PRODUCT_ID
                WHERE ci.COMBINATION_ID = c.COMBINATION_ID
            ) AS originalTotalPrice,
            (
                SELECT SUM(TRUNC(p.price * (1 - NVL(p.discount_rate, 0)/100), -2))
                FROM COMBINATION_ITEM ci
                         JOIN PRODUCT p ON ci.PRODUCT_ID = p.PRODUCT_ID
                WHERE ci.COMBINATION_ID = c.COMBINATION_ID
            ) AS discountedTotalPrice
        FROM COMBINATION c
                 JOIN MEMBER m ON c.MEMBER_ID = m.MEMBER_ID
        WHERE c.COMBINATION_ID = #{combinationId}
    </select>

    <select id="findCombinationProducts" parameterType="long" resultType="com.refit.app.domain.combination.dto.CombinationProductDto">
        SELECT
            p.PRODUCT_ID    AS productId,
            p.BRAND_NAME    AS brandName,
            p.PRODUCT_NAME  AS productName,
            p.PRICE         AS price,
            p.DISCOUNT_RATE AS discountRate,
            p.THUMBNAIL_URL AS thumbnailUrl,
            TRUNC(p.price * (1 - NVL(p.discount_rate, 0)/100), -2) AS discountedPrice
        FROM COMBINATION_ITEM ci
                 JOIN PRODUCT p ON ci.PRODUCT_ID = p.PRODUCT_ID
        WHERE ci.COMBINATION_ID = #{combinationId}
    </select>

    <!-- 시퀀스 불러오기 -->
    <select id="getNextCombinationId" resultType="long">
        SELECT SEQ_COMBINATION.NEXTVAL FROM DUAL
    </select>

    <!-- 새 조합 생성 -->
    <insert id="insertCombination">
        INSERT INTO COMBINATION (
            COMBINATION_ID,
            MEMBER_ID,
            COMBINATION_NAME,
            COMBINATION_DESCRIPTION,
            LIKES,
            BH_TYPE,
            CREATED_AT,
            CREATED_BY,
            UPDATED_AT,
            UPDATED_BY
        )
        VALUES (
                   #{id},
                   #{memberId},
                   #{name},
                   #{content},
                   0,
                   #{bhType},
                   SYSTIMESTAMP,
                   #{memberId},
                   SYSTIMESTAMP,
                   #{memberId}
               )
    </insert>

    <!-- 조합 내 상품 추가 -->
    <insert id="insertCombinationItem">
        INSERT INTO COMBINATION_ITEM (
            COMBINATION_ITEM_ID,
            COMBINATION_ID,
            PRODUCT_ID
        )
        VALUES (
                   SEQ_COMBINATION_ITEM.NEXTVAL,
                   #{combinationId},
                   #{productId}
               )
    </insert>

</mapper>
